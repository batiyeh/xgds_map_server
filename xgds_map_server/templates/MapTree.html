{% extends "MapBase.html" %}
{% block scripts %}
{{ block.super }}
	<script type="text/javascript" src='{{ EXTERNAL_URL }}js-cookie/src/js.cookie.js'></script>
    <script type="text/javascript" src='{{ EXTERNAL_URL }}jquery-ui/jquery-ui.min.js'></script>
    <script type="text/javascript" src='{{ EXTERNAL_URL }}fancytree/dist/jquery.fancytree.js'></script>
    <script type="text/javascript" src='{{ EXTERNAL_URL }}fancytree/dist/src/jquery.fancytree.dnd.js'></script>
    <script type="text/javascript" src='{{ EXTERNAL_URL }}fancytree/dist/src/jquery.fancytree.filter.js'></script>
    <script type="text/javascript" src='{{ EXTERNAL_URL }}fancytree/dist/src/jquery.fancytree.persist.js'></script>
    <script type="text/javascript" src='{{ EXTERNAL_URL }}lodash/lodash.min.js'></script>
    <script type="text/javascript" src='{{STATIC_URL}}xgds_map_server/js/tree/fancyTreeSlider.js'></script>
{% endblock %}

{% block contents %}
<strong>Add</strong>
<a href="{% url 'folderAdd' %}" class="mybutton small">Folder</a>
<a href="{% url 'addKml' %}" class="mybutton small">Kml</a>
<a href="{% url 'mapAddLayer' %}" class="mybutton small">Layer</a>
<a href="{% url 'mapAddTile' %}" class="mybutton small">Tile</a>
<!-- <a href="{% url 'mapAddMapCollection' %}" class="mybutton">Collection</a> -->
<a href="{% url 'deletedNodes' %}" class="mybutton small">Undelete</a>
<style scoped>
  @import url('{{EXTERNAL_URL}}jquery-ui/themes/base/jquery-ui.css');
  @import url('{{ EXTERNAL_URL }}fancytree/dist/skin-lion/ui.fancytree.min.css');
  @import url('{{ STATIC_URL }}xgds_map_server/css/fancytree_custom.css');
  ul.fancytree-container {
 	 height: 400px;
  	 width: 95%;
  }
</style>
<div id="layertreeContainer">
	<p class="small">
	Drag and drop to reorganize tree.  Double-click to edit. <br/>
	Checked = layer is turned on by default globally. <br/>
	Transparency settings are global.
	</p>
	<button alt="refresh" id="refreshTreeLink" class="small" onclick="javascript: refreshTree();">Refresh</button>
	<input name="searchTree" placeholder="Filter..." autocomplete="off">
   	<button id="btnResetSearch" class="small">&times;</button>
   	<span id="matches"></span>
	<button id="btnTransparencyEditors" class="small" style="{float:right;}" onclick="toggleTransparencySliders();">Transparency</button>
	<div id="layertree" ></div> <!-- data-source="ajax" class="sampletree"></div> -->
 </div>
{% endblock %}

{% block jsInit %}
{{ block.super }}
   persistTransparency = true;
   var setVisibilityURL = "{{ setVisibilityURL }}";
   var moveNodeURL = "{{ moveNodeURL }}";
   var layerFeedUrl =  "{{ JSONMapTreeURL }}"; // "{{ settings.XGDS_PLANNER2_LAYER_FEED_URL }}";
   var layertreeNode = $("#layertree");
   var theTree;
   $.ajax({url: layerFeedUrl,
           dataType: 'json',
           success: $.proxy(function(data) {
           		initializeTree(data);
           		connectFilter();
         	})
         });
   var connectFilter = function() {
    	$("button#btnResetSearch").click(function(e){
    	      $("input[name=searchTree]").val("");
    	      $("span#matches").text("");
    	      theTree.clearFilter();
    	    }).attr("disabled", true);
    	
    	$("input[name=searchTree]").keyup(function(e){
    	      var n,
    	        opts = {
    	          autoExpand: true,
    	          leavesOnly: false
    	        },
    	        match = $(this).val();

    	      if(e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === ""){
    	        $("button#btnResetSearch").click();
    	        return;
    	      }
//    	      if($("#regex").is(":checked")) {
//    	        // Pass function to perform match
//    	        n = theTree.filterNodes(function(node) {
//    	          return new RegExp(match, "i").test(node.title);
//    	        }, opts);
//    	      } else {
    	        // Pass a string to perform case insensitive matching
    	        n = theTree.filterNodes(match, opts);
//    	      }
    	      $("button#btnResetSearch").attr("disabled", false);
    	      $("span#matches").text("(" + n + " matches)");
    	    }).focus();
    };
   var initializeTree = function(data) {
    layertreeNode.fancytree({
       source: data,
       checkbox: true,
       extensions: ['dnd','persist','filter', 'transparency_slider'],
       autoActivate: false,
       autoScroll: false,
       dblclick: function(event, data) {
         	window.location.href=data.node.data.href;
       },
       filter: {
                    autoApply: true,  // Re-apply last filter if lazy data is loaded
                    counter: true,  // Show a badge with number of matching child nodes near parent icons
                    fuzzy: false,  // Match single characters in order, e.g. 'fb' will match 'FooBar'
                    hideExpandedCounter: true,  // Hide counter badge, when parent is expanded
                    highlight: true,  // Highlight matches by wrapping inside <mark> tags
                    mode: "hide",  // Hide unmatched nodes (pass "dimm" to gray out unmatched nodes)
                    autoExpand: true
                  },
       select: function(event, data) {
	       // toggle default visibility
	       var params = { 'nodeUuid': data.node.key, 'visible': data.node.isSelected()};
        	$.ajax({url: setVisibilityURL,
  					type: 'POST',
  					dataType: 'json',
  					data: params,
				}).success(function() {
				}).error(function() {
					data.node.setSelected(!data.node.isSelected());
					alert("Problem changing visibility for " + data.node.label);
				});
        },
        dnd: {
	        autoExpandMS: 400,
	        focusOnClick: true,
	        preventVoidMoves: true, // Prevent dropping nodes 'before self', etc.
	        preventRecursiveMoves: true, // Prevent dropping nodes on own descendants
	        dragStart: function(node, data) {
	          return true;
	        },
	        dragEnter: function(node, data) {
	        	// we only support dropping onto a folder, we don't do reordering
		        if (!_.isUndefined(data.node.folder) && (data.node.folder == true)) {
	    	    	return 'over';
	        	}
	        	return false;
	        },
	        dragDrop: function(node, data) {
	        	var params = { 'nodeUuid': data.otherNode.key, 'parentUuid': data.node.key};
	        	$.ajax({url: moveNodeURL,
	  					type: 'POST',
	  					dataType: 'json',
	  					data: params,
					}).success(function() {
						data.otherNode.moveTo(node, data.hitMode);
					}).error(function() {
						alert("Problem moving node, try again.");
					});
	        	}
	      	},
   		}); 
   	 theTree = layertreeNode.fancytree("getTree");
   	 app = {tree:theTree};
   };
   
   var refreshTree = function() {
        if (!_.isUndefined(theTree)){
            theTree.reload({
                url: layerFeedUrl
            });
        }
    }
    

{% endblock %}
